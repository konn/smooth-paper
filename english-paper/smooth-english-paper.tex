\documentclass[%
  sigconf,authorversion,screen]{acmart}
\usepackage{amsmath}
\input{preamble}

\begin{document}

\title[Automatic Differentiation With Higher Infinitesimals]{Automatic Differentiation With Higher Infinitesimals, or Computational Smooth Infinitesimal Analysis in Weil Algebra}

\author{Hiromi ISHII}
\email{h-ishii@math.tsukuba.ac.jp}
\affiliation{%
  \institution{DeepFlow, Inc.}
  \streetaddress{3-16-40}
  \city{Fujimi-shi Tsuruse nishi}
  \state{Saitama prefecture}
  \country{Japan}
  \postcode{354-0026}
}

\renewcommand{\shortauthors}{Hiromi ISHII}

\begin{abstract}
  \frenchspacing
  We propose an algorithm to compute the $C^\infty$-ring structure of arbitrary Weil algebra, enabling us to do some analysis with \emph{higher inifinitesimals} numerically and symbolically.
  To that end, we first give a brief description of the (forward-mode) automatic differentiation in terms of $C^\infty$-rings.
  The notion of $C^\infty$-ring is introduced by Lawvere~\cite{lawvere1979categorical}, and used as the fundamental building block of \emph{smooth infinitesimal analysis} and \emph{synthetic differential geometry}~\cite{Moerdijk:1991aa}.
\end{abstract}

\begin{CCSXML}
<ccs2012>
    <concept>
        <concept_id>10010147.10010148.10010149.10010154</concept_id>
        <concept_desc>Computing methodologies~Hybrid symbolic-numeric methods</concept_desc>
        <concept_significance>500</concept_significance>
        </concept>
    <concept>
        <concept_id>10010147.10010148.10010149.10010150</concept_id>
        <concept_desc>Computing methodologies~Algebraic algorithms</concept_desc>
        <concept_significance>500</concept_significance>
        </concept>
    <concept>
        <concept_id>10010147.10010148.10010149.10010152</concept_id>
        <concept_desc>Computing methodologies~Symbolic calculus algorithms</concept_desc>
        <concept_significance>500</concept_significance>
        </concept>
    <concept>
        <concept_id>10002950.10003714.10003732.10003734</concept_id>
        <concept_desc>Mathematics of computing~Differential calculus</concept_desc>
        <concept_significance>500</concept_significance>
        </concept>
  </ccs2012>
\end{CCSXML}

\ccsdesc[500]{Computing methodologies~Hybrid symbolic-numeric methods}
\ccsdesc[500]{Computing methodologies~Algebraic algorithms}
\ccsdesc[500]{Computing methodologies~Symbolic calculus algorithms}
\ccsdesc[500]{Mathematics of computing~Differential calculus}
  
\keywords{automatic differentiation, %
  smooth infinitesimal analysis, %
  Weil algebras,%
  smooth algebras, $C^\infty$-rings, %
  symbolic-numeric algorihtms,
  symbolic differentiation, %
  Gr\"{o}bner basis, zero-dimensional ideals}

\maketitle

\section{Introduction}\label{sec:intro}
\sloppy
\emph{Automatic Differentiation} (or, \emph{AD} for short) is known as the method to calculate derivatives of (piecewise) smooth functions accurately and efficiently\fxnote{More elaboration needed}.

This paper is organised as follows.
In \Cref{sec:prel}, we will briefly review the basic concepts and facts on $C^\infty$-rings and Weil algebras.
Subsequently, we will give some exposition of the connection between forward-mode automatic differentiation and Weil algebras in \Cref{sec:ad-and-weils}.
There, we will see how the notion of Weil algebra can be exploited to treat higher-order partial ADs in a unified and general setting.
Then in \Cref{sec:alg}, we will give algorithms to compute $C^\infty$-ring structure of arbitrary Weil algebra, enabling us \emph{automatic differentiation with higher infinitesimals}, or \emph{computational smooth infinitesimal analysis}.
We give some small examples in \Cref{sec:examples}, using our proof-of-concept implementation~\cite{Ishii:2020aa} in Haskell.
Finally, we discuss related and possible future works and conclude in \Cref{sec:concl}.

\section{Preliminaries}\label{sec:prel}
In this section, we will briefly review classical definitions and facts on Weil algebras and $C^\infty$-rings without proofs, which will be used in \Cref{sec:alg}.
For theoretical detail, we refer readers to Moerdijk--Reyes~\cite[Chapters I and II]{Moerdijk:1991aa} or Joyce~\cite{joyce2016algebraic}.

\begin{definition}[Lawvere~\cite{lawvere1979categorical}]
  A \emph{$C^\infty$}-algebra $A$ is a product-preserving functor from the category $\CartSp$ of finite-dimensional Euclidean spaces and smooth maps to the category $\Sets$ of sets.

  We identify $A$ with a $A(\R)$ and $A^n$ with $A(\R^n)$.
\end{definition}

Intuitively, $C^\infty$-ring $A$ is an $\R$-algebra $A$ augmented with $m$-ary operations $A(f): A^m \to A$ respecting composition and product for all smooth map $f: \R^m \to \R$.

One typical example of $C^\infty$-ring is a formal power series ring:

\begin{theorem}[Lawvere]\label{thm:series-is-smooth}
  A ring $\R\llbracket X_1, \dots, X_n\rrbracket$ of formal power series with finite variables has the $C^\infty$-ring structure via Taylor expansion at $0$.
  In particular, lifting of a smooth map $f: \R^m \to \R$ is given by:
  \[
    \Rseries(f)(g_1, \dots, g_m) = \sum_{\alpha \in \N^n} \frac{\X^\alpha}{\alpha!} D^\alpha(f \circ \braket{g_1, \dots, g_n})(\boldsymbol{0}),
  \]
  where $\alpha! = \alpha_1 ! \dots \alpha_n !$ is the multi-index factorial and $D^\alpha$ is the partial differential operator to degree $\alpha$.
\end{theorem}

$C^\infty$-rings of our central interest in this paper is \emph{Weil algebras}, and has deep connection with $\Rseries$:

\begin{definition}[Weil algebra]
  A \emph{Weil algebra} $W$ is an algebra of form $W = \R[X_1, \dots, X_n]/I$ for some ideal $I \subseteq \R[\X]$ such that $\braket{X_1, \dots, X_n}^k \subseteq I$ for some $k \in \N$.
\end{definition}
It follows that Weil algebra $W$ is finite-dimensional as a $R$-linear space and hence $I$ is a \emph{zero-dimensional} ideal.
Weil algebra $W$ can be regarded as a real line $\R$ augmented with nilpotent infinitesimals $d_i = {[X_i]}_I$.
In what follows, we identify an element $\boldsymbol{u} \in W$ of $k$-dimensional Weil algebra $W$ with a $k$-vector $\boldsymbol{u} = (u_1, \dots, u_k) \in \R^k$ of reals.

Although it is not so clear from the definition, Weil algebras have the canonical $C^\infty$-structure.
First note that, if $I$ is zero-dimensional, we have $\R[\X]/I \simeq \R\llbracket \X \rrbracket /I$.
Hence, in particular, Weil algebra $W$ can also be regarded as a quotient ring of formal power series by zero-dimensional ideal.
Thus, together with \Cref{thm:series-is-smooth}, the following lemma shows that any Weil algebra $W$ has the canonical $C^\infty$-ring structure:

\begin{lemma}
  For any $C^\infty$-ring $A$ and a ring-theoretical ideal $I \subseteq A$, the quotient ring $A/I$ again has the canonical $C^\infty$-ring structure.
  In particular, the $C^\infty$-structure of Weil algebra $W$ is given just by post-composition of a quotient mapping to that of $\Rseries$.
\end{lemma}

\section{Connection between Automatic Differentiation and Weil Algebras}
\label{sec:ad-and-weils}

\begin{definition}
  The \emph{dual number ring} is a Weil algebra $\R[X]/(X^2)$.
  We often write $d = {(X)}_I \in \R[d]$ and $\R[d] \coloneq \R[X]/X^2$.

  We use analogous notation for multivariate versions:
  
  \[
    \R[d_1, \dots, d_k] \coloneq \R[\X]/(X_1^2, \dots, X_k^2)
    \simeq \underbrace{\R[d] \otimes_\R \dots \otimes_\R \R[d]}_{k\text{-copies}}
  \]
\end{definition}

By an easy induction, we can show the following:
\begin{theorem}\label{thm:univ-partial-duals}
  For any $f: \R^n \smoothto \R$ and $\boldsymbol{x} \in \R^n$, we have:
  \[
    \R[d_1, \dots, d_k](f)(x + d_1 + \cdots d_n) 
    = \sum_{0 \leq i \leq n} f^{(i)}(x)\sigma^i_n(\vec{d}),
  \]
  where, $\sigma^i_k(x_1, \dots, x_k)$ denotes the $k$-variate elementary symmetric polynomial of degree $i$.
\end{theorem}

It immediately extends to the multivariate case.

\begin{theorem}\label{thm:multi-partial-duals}
  Let
  \[
    W \coloneq \R[d_{1,1}, \dots, d_{1,k_1}] \otimes_\R \dots \otimes_\R \R[d_{n,1}, \dots, d_{n,k_n}].
  \]
  For any $f: \R^n \smoothto \R$ and $\boldsymbol{x} \in \R^n$, we have:
  \begin{align*}
    &W(f)\left(x + \sum_{j \leq n}\sum_{i \leq k_j} d_{j,i}\right) \\
    = &\sum_{\alpha \leq (k_1,\dots,k_n)} \mathop{D}\nolimits^\alpha f(\boldsymbol{x})
    \sigma^{\alpha_1}_{k_1}(\vec{d}_1) 
    \cdots
    \sigma^{\alpha_n}_{k_n}(\vec{d}_n).
  \end{align*}
  In particular, for $\alpha \leq (k_1, \dots, k_n)$, a partial coefficient $D^\alpha(f)(\boldsymbol{x})$ is given by a coefficient of $d_{1,1}^{\alpha_1} d_{2,1}^{\alpha_2} \cdots d_{n,1}^{\alpha_2}$ in $W(f)(\boldsymbol{x})$.
\end{theorem}
This illustrates how we can derive higher-order AD from the first-order forward-mode AD.
If we continue this ad infinitum and lazily, we can reach the same method as so-called Tower AD (see~\cite{Pearlmutter:2007aa,Kmett:2010aa} for detail and implementation).

\section{Algorithms}\label{sec:alg}
In this section, we will present the main results of this paper: concrete algorithms to compute $C^\infty$-structure of arbitrary Weil algebra.
Roughly speaking, the algorithms can be divided into threefold:

\begin{enumerate}
  \item A procedure deciding Weil-ness of an ideal and returning data required to compute $C^\infty$-structure (\textsc{WeilTest}, \Cref{alg:weil-test}),
  \item A procedure to compute the lifting  $W(f): W^m \to W$ to Weil albgebra $W$ from $\Rseries(f)$ (\textsc{LiftWeil}, \Cref{alg:smooth-weil}), and
  \item A procedure to lift smooth map $f: \R^m \to \R$ to the $m$-variate formal power series ring $\Rseries$.\label{step:lift-series}
\end{enumerate}

As we shall see later, in step~\ref{step:lift-series}, we don't need overall coefficients lifted to $\Rseries$ but only a finite fragment.

We start with Weil-ness testing:

\begin{algorithm}[\textsc{WeilTest}]\label{alg:weil-test}
  \hspace{1em}\vspace{-.25em}
  \begin{description}
    \item[Input] An ideal $I \subseteq \mathbb{R}[X_1, \dots, X_n]$
    \item[Output] Returns the following data if $W = \mathbb{R}[\boldsymbol{X}]/I$ is a Weil algebra; otherwise \verb|No|.
    \begin{enumerate}
      \item Monomial basis $\set{\boldsymbol{b}_1, \dots, \boldsymbol{b}_\ell}$ of $W$,
      \item $M$, the multiplication table of $W$ in terms of the basis,
      \item $(k_1, \dots, k_n) \in \mathbb{N}^n$ such that $k_i$ is the maximum satisfying $X_i^{k_i} \notin I$ for each $i$, and
      \item $\NonVan_W$, a table of representations of non-vanishing monomials in $W$;
      i.e.\ for any $\alpha = (\alpha_1, \dots, \alpha_n) \in \N^n$, if $\alpha_i \leq k_i$ for all $i$, then $\NonVan_W(\X^\alpha) = (c_1, \dots, c_n) \in \R^k$ satisfies $[\X^\alpha]_I = \sum_i c_i \boldsymbol{b}_i$.
    \end{enumerate} 
    \item[Procedure] \textup{\textsc{WeilTest}}
  \end{description}

  \begin{alg}
G <- calcGroebnerBasis(I)
If @$I$@ is not zero-dimensional
  Return No
@$\set{\boldsymbol{b}_1, \dots, \boldsymbol{b}_\ell}$@ <- Monomial basis of @$I$@
@$M$@ <- the Multiplication table of @$W$@
For i in 1..n@\label{line:weil-test:radical-start}@
  @$p_i$@ <- the monic generator of @$I \cap \R[X_i]$@
  Return No If @$p_i$@ is not a monomial
  @$k_i$@ <- @$\deg(p_i) - 1$@@\label{line:weil-test:radical-end}@
@$\NonVan_W$@ <- {}
For @$\alpha$@ in @$\Set{\alpha \in \N^n | \alpha_i \leq k_i \; \forall i \leq \ell}$@
  @$c_1 \boldsymbol{b}_1 + \cdots + c_\ell \boldsymbol{b}_\ell$@ <- @$\rem{\X^\alpha}{G}$@
  @$\NonVan_W(\X^\alpha)$@ <- (@$c_1, \dots, c_\ell$@)
Return (@$\vec{\boldsymbol{b}}, M, \vec{k}, \NonVan_W$@)
\end{alg}
\end{algorithm}

\begin{theorem}
  \Cref{alg:weil-test} terminates and returns expected values.
\end{theorem}
\begin{proof}
  Algorithms to decide the zero-dimensionality and calculate their multiplication table is well-known (for detail we refer readers to Cox--Little--O'Shea~\cite[Chapter 2]{CLO:2005}).
  So the only non-trivial part is nilpotence detection (\Crefrange{line:weil-test:radical-start}{line:weil-test:radical-end}).
  But, again, this is just a variation of radical calculation algorithm for zero-dimensional ideals.
  Indeed, since each $\R[X_i]$ is a PID, we have $X_i^k \in I \cap R[X_i]$ iff $p_i \divs X_i^k$, hence $p_i$ must be a monomial iff $X_i$ is nilpotent in $W$.
\end{proof}
Now that we have information of a basis and multiplication table, we can calculate ordinary algebraic operations and take tensor products of Weil algebras just by the standard means.

And, with upper bounds $\vec k$ of powers and representations $\NonVan_W$ of non-vanishing monomials, we can now compute the $C^\infty$-structure of arbitrary Weil algebra, when given a lifting of smooth mapping $f$ to $\Rseries$:

\begin{algorithm}[\textsc{LiftWeil}]\label{alg:smooth-weil}
  \hfill\vspace{-.25em}
  \begin{description}
    \item[Input]
      $I \subseteq \R[\X]$, an ideal where $W = \R[\X]/I$ is a Weil algebra,
      $\R \llbracket\X\rrbracket(f): \Rseries^m \to \Rseries$, a lifting of a smooth map $f: \R^m \to \R$ to $\Rseries$, and $\vec{\boldsymbol{u}} = (\boldsymbol{u}_1, \dots, \boldsymbol{u}_m) \in W^m$,.
    \item[Output] $\boldsymbol{v} = W(f)(\vec{\boldsymbol u}) \in W$, the value of $f$ at $\vec{\boldsymbol{u}}$ given by $C^\infty$-structure.
    \item[Procedure] \textup{\textsc{LiftWeil}}
  \end{description}
\begin{alg}
(@$\vec{\boldsymbol{b}}$@, M, @$\vec{k}$@, @$\NonVan_W$@) <- WeilTest(I)
g_i <- @$(\boldsymbol{b}_1, \dots, \boldsymbol{b}_k) \cdot \boldsymbol{u}_i \in \R[\X]$@ for i <= m
h = @$\sum_\alpha c_\alpha \X^\alpha$@ <- @$\Rseries(f)(\vec{g})$@
@$\boldsymbol v$@ <- 0
For alpha with @$\alpha_i \leq k_i\, \forall i$@
  @$\boldsymbol{v}$@ <- @$\boldsymbol v$@ + @$c_\alpha \NonVan_W(\X^\alpha)$@
Return @$\boldsymbol{v}$@
\end{alg}
\end{algorithm}

The termination and validity of \Cref{alg:smooth-weil} are clear.

It remains to compute $C^\infty$-structure of $\Rseries$.
Thanks to \Cref{alg:smooth-weil}, we know the precise definition of lifting to $\Rseries$.
Given $f: \R^n \smoothto \R$, we could employ a purely symbolic algorithm to calculate an entire power series.
On the other hand, symbolic computation along this line could be quite expensive without any heuristics.
One possible alternative is to employ Lazy multivariate Tower AD~\cite{Pearlmutter:2007aa} or Sparse Tower mode\footnote{For an implementation, see, for example, \texttt{Numeric.AD.Internal.Sparse} module of \texttt{ad}~\cite{Kmett:2010aa}.}.
These methods can be obtained by applying \Cref{thm:multi-partial-duals} ad infinitum.
If one uses a language with easy laziness support, our task is done by Tower AD.
Fortunately enough, we don't need the entire information of power series.
Concerning the use of power series in \Cref{alg:smooth-weil}, we need only a finite fragment of the series of interest; we need the coefficients up to multidegree $(k_1, \dots, k_n)$.
Hence, we can resort to automatic differentiation up to a fixed degree, so one can just apply ADs finitely many times as \Cref{thm:multi-partial-duals} required.
Equivalently, one can implement the $C^\infty$-structure of multi-dual number ring $\R[\vec{d}]$ directly and use them.

\section{Examples}\label{sec:examples}
We have implemented the algorithms introduced in the previous section on top of the \texttt{computational-algebra}~\cite{ISHII:2018ek,computational-algebra} package, a computer algebra system implemented as an Embedded Domain Specific Language in Haskell.
The code is available on GitHub~\cite{Ishii:2020aa}.

\section{Conclusion}\label{sec:concl}

\section*{Appendix: Symbolic computation of smooth structure }\label{sec:appendix}

\begin{acks}
The author is grateful to Prof.\ Akira Terui, for encouraging  to write this paper.

This work was supported by the Research Institute for Mathematical Sciences,
an International Joint Usage/Research Center located in Kyoto University.
\end{acks}

\bibliographystyle{ACM-Reference-Format}
\bibliography{../references}

\end{document}
\endinput
